<Page x:Class="IRIS.Views.TriagePage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:IRIS.Views"
      xmlns:controls="clr-namespace:IRIS.Controls"
      xmlns:converters="clr-namespace:IRIS.Converters"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1000"
      Title="Triage"
      Tag="Triage des preuves">

    <Page.Resources>
        <ResourceDictionary>
            <converters:BoolToVisibilityConverter x:Key="BoolToVis" />
            <converters:PriorityToBrushConverter x:Key="PriorityToBrush" />
            <converters:ThreatLevelToBrushConverter x:Key="ThreatToBrush" />
        </ResourceDictionary>
    </Page.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- En-tête de la page -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock Text="Triage intelligent" 
                       Style="{StaticResource PageTitleStyle}" />
            <TextBlock Text="Priorisez les preuves numériques selon leur pertinence et les menaces détectées" 
                       Style="{StaticResource PageDescriptionStyle}" 
                       Margin="0,5,0,0" />
        </StackPanel>

        <!-- Contenu principal -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Panneau de filtres et options -->
            <Border Grid.Column="0" 
                    Background="{DynamicResource PanelBackgroundBrush}" 
                    CornerRadius="8" 
                    Padding="15">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="Filtres et options" 
                                   Style="{StaticResource SectionTitleStyle}" 
                                   Margin="0,0,0,15" />

                        <!-- Source de preuves -->
                        <TextBlock Text="Source de preuves" 
                                   Style="{StaticResource LabelTextStyle}" />
                        <ComboBox ItemsSource="{Binding EvidenceSources}" 
                                  SelectedItem="{Binding SelectedEvidenceSource}" 
                                  Margin="0,5,0,15" />

                        <!-- Filtres de type -->
                        <TextBlock Text="Types de preuves" 
                                   Style="{StaticResource LabelTextStyle}" />
                        <StackPanel Margin="0,5,0,15">
                            <CheckBox Content="Fichiers" 
                                      IsChecked="{Binding IncludeFiles}" 
                                      Margin="0,0,0,5" />
                            <CheckBox Content="Logs" 
                                      IsChecked="{Binding IncludeLogs}" 
                                      Margin="0,0,0,5" />
                            <CheckBox Content="Registre" 
                                      IsChecked="{Binding IncludeRegistry}" 
                                      Margin="0,0,0,5" />
                            <CheckBox Content="Mémoire" 
                                      IsChecked="{Binding IncludeMemory}" 
                                      Margin="0,0,0,5" />
                            <CheckBox Content="Réseau" 
                                      IsChecked="{Binding IncludeNetwork}" 
                                      Margin="0,0,0,5" />
                        </StackPanel>

                        <!-- Filtres MITRE ATT&CK -->
                        <Expander Header="Filtres MITRE ATT&CK" 
                                  Margin="0,0,0,15">
                            <StackPanel Margin="0,10,0,0">
                                <TextBlock Text="Techniques" 
                                           Style="{StaticResource LabelTextStyle}" 
                                           Margin="0,0,0,5" />
                                <CheckBox Content="Exécution (T1059)" 
                                          Tag="T1059"
                                          Checked="MITREFilterCheckBox_Checked"
                                          Unchecked="MITREFilterCheckBox_Unchecked"
                                          Margin="0,0,0,5" />
                                <CheckBox Content="Persistance (T1547)" 
                                          Tag="T1547"
                                          Checked="MITREFilterCheckBox_Checked"
                                          Unchecked="MITREFilterCheckBox_Unchecked"
                                          Margin="0,0,0,5" />
                                <CheckBox Content="Élévation de privilèges (T1548)" 
                                          Tag="T1548"
                                          Checked="MITREFilterCheckBox_Checked"
                                          Unchecked="MITREFilterCheckBox_Unchecked"
                                          Margin="0,0,0,5" />
                                <CheckBox Content="Contournement de défense (T1562)" 
                                          Tag="T1562"
                                          Checked="MITREFilterCheckBox_Checked"
                                          Unchecked="MITREFilterCheckBox_Unchecked"
                                          Margin="0,0,0,5" />
                                <CheckBox Content="Vol d'identifiants (T1555)" 
                                          Tag="T1555"
                                          Checked="MITREFilterCheckBox_Checked"
                                          Unchecked="MITREFilterCheckBox_Unchecked"
                                          Margin="0,0,0,5" />
                                <CheckBox Content="Exfiltration (T1567)" 
                                          Tag="T1567"
                                          Checked="MITREFilterCheckBox_Checked"
                                          Unchecked="MITREFilterCheckBox_Unchecked"
                                          Margin="0,0,0,5" />
                                <CheckBox Content="Chiffrement d'impact (T1486)" 
                                          Tag="T1486"
                                          Checked="MITREFilterCheckBox_Checked"
                                          Unchecked="MITREFilterCheckBox_Unchecked"
                                          Margin="0,0,0,5" />
                            </StackPanel>
                        </Expander>

                        <!-- Filtres de date -->
                        <TextBlock Text="Plage de dates" 
                                   Style="{StaticResource LabelTextStyle}" />
                        <Grid Margin="0,5,0,15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Column="0" Grid.Row="0" 
                                       Text="Du" 
                                       HorizontalAlignment="Center" 
                                       Margin="0,0,0,5" />
                            <TextBlock Grid.Column="2" Grid.Row="0" 
                                       Text="Au" 
                                       HorizontalAlignment="Center" 
                                       Margin="0,0,0,5" />
                            <DatePicker Grid.Column="0" Grid.Row="1" 
                                        SelectedDate="{Binding StartDate}" />
                            <TextBlock Grid.Column="1" Grid.Row="1" 
                                       Text="-" 
                                       VerticalAlignment="Center" 
                                       Margin="5,0" />
                            <DatePicker Grid.Column="2" Grid.Row="1" 
                                        SelectedDate="{Binding EndDate}" />
                        </Grid>

                        <!-- Niveau de menace -->
                        <TextBlock Text="Niveau de menace minimum" 
                                   Style="{StaticResource LabelTextStyle}" />
                        <ComboBox ItemsSource="{Binding ThreatLevels}" 
                                  SelectedItem="{Binding MinimumThreatLevel}" 
                                  Margin="0,5,0,15" />

                        <!-- Assistance IA -->
                        <Grid Margin="0,0,0,15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" 
                                       Text="Assistance IA" 
                                       Style="{StaticResource LabelTextStyle}" />
                            <ToggleButton Grid.Column="1" 
                                          IsChecked="{Binding UseAI}"
                                          Checked="AIAssistToggle_Checked"
                                          Unchecked="AIAssistToggle_Unchecked" />
                        </Grid>

                        <!-- Description IA -->
                        <Border Background="{DynamicResource InfoBackgroundBrush}" 
                                BorderBrush="{DynamicResource InfoBorderBrush}" 
                                BorderThickness="1" 
                                CornerRadius="4" 
                                Padding="10" 
                                Margin="0,0,0,15"
                                Visibility="{Binding UseAI, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="L'IA analysera automatiquement les preuves pour identifier les menaces potentielles et suggérer des priorités basées sur le contexte de l'investigation." 
                                       TextWrapping="Wrap" 
                                       Foreground="{DynamicResource InfoTextBrush}" 
                                       FontSize="12" />
                        </Border>

                        <!-- Boutons d'action -->
                        <Button Content="Appliquer les filtres" 
                                Style="{StaticResource PrimaryButtonStyle}" 
                                Margin="0,10,0,0"
                                Command="{Binding ApplyFilterCommand}"
                                Click="ApplyFilterButton_Click" />
                        <Button Content="Réinitialiser les filtres" 
                                Style="{StaticResource SecondaryButtonStyle}" 
                                Margin="0,10,0,0"
                                Command="{Binding ResetFilterCommand}"
                                Click="ResetFilterButton_Click" />
                        <Button Content="Démarrer le triage automatique" 
                                Style="{StaticResource PrimaryButtonStyle}" 
                                Margin="0,20,0,0"
                                Command="{Binding StartTriageCommand}"
                                Click="StartTriageButton_Click" />
                        <Button Content="Annuler" 
                                Style="{StaticResource SecondaryButtonStyle}" 
                                Margin="0,10,0,0"
                                Command="{Binding CancelTriageCommand}"
                                Click="CancelTriageButton_Click"
                                Visibility="{Binding IsTriageRunning, Converter={StaticResource BoolToVis}}" />
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- Liste des preuves -->
            <Grid Grid.Column="1" Margin="20,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- En-tête de la liste -->
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" 
                               Text="Preuves à trier" 
                               Style="{StaticResource SectionTitleStyle}" />
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Content="Charger un triage" 
                                Style="{StaticResource SecondaryButtonStyle}" 
                                Margin="0,0,10,0"
                                Command="{Binding LoadTriageCommand}"
                                Click="LoadTriageButton_Click" />
                        <Button Content="Enregistrer le triage" 
                                Style="{StaticResource SecondaryButtonStyle}" 
                                Command="{Binding SaveTriageCommand}"
                                Click="SaveTriageButton_Click" />
                    </StackPanel>
                </Grid>

                <!-- Liste des preuves -->
                <Border Grid.Row="1" 
                        Background="{DynamicResource PanelBackgroundBrush}" 
                        CornerRadius="8" 
                        Margin="0,10,0,0">
                    <Grid>
                        <!-- Message quand aucune preuve -->
                        <TextBlock Text="Aucune preuve disponible. Sélectionnez une source de preuves et appliquez les filtres." 
                                   HorizontalAlignment="Center" 
                                   VerticalAlignment="Center" 
                                   TextWrapping="Wrap" 
                                   TextAlignment="Center" 
                                   Foreground="{DynamicResource SecondaryTextBrush}"
                                   Visibility="{Binding HasEvidence, Converter={StaticResource BoolToVis}, ConverterParameter=invert}" />

                        <!-- Triage en cours -->
                        <Grid Visibility="{Binding IsTriageRunning, Converter={StaticResource BoolToVis}}">
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                <controls:CircularProgressBar Width="50" 
                                                             Height="50" 
                                                             IsActive="True" />
                                <TextBlock Text="{Binding TriageStatusMessage}" 
                                           Margin="0,20,0,0" 
                                           TextAlignment="Center" />
                                <TextBlock Text="{Binding TriageProgress, StringFormat={}{0:P0}}" 
                                           Margin="0,5,0,0" 
                                           TextAlignment="Center" 
                                           FontSize="18" 
                                           FontWeight="Bold" />
                                <ProgressBar Value="{Binding TriageProgress}" 
                                             Maximum="1" 
                                             Width="200" 
                                             Height="10" 
                                             Margin="0,10,0,0" />
                                <TextBlock Text="{Binding ItemsProcessed, StringFormat=Éléments traités: {0}}" 
                                           Margin="0,10,0,0" 
                                           TextAlignment="Center" 
                                           Foreground="{DynamicResource SecondaryTextBrush}" />
                            </StackPanel>
                        </Grid>

                        <!-- Liste des preuves -->
                        <ListView ItemsSource="{Binding EvidenceItems}" 
                                  BorderThickness="0" 
                                  Background="Transparent"
                                  Visibility="{Binding HasEvidence, Converter={StaticResource BoolToVis}}">
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource CardBackgroundBrush}" 
                                            BorderBrush="{DynamicResource BorderBrush}" 
                                            BorderThickness="1" 
                                            CornerRadius="4" 
                                            Padding="15" 
                                            Margin="5">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <!-- Indicateur de priorité -->
                                            <Border Grid.Column="0" Grid.Row="0" Grid.RowSpan="4" 
                                                    Background="{Binding Priority, Converter={StaticResource PriorityToBrush}}" 
                                                    Width="5" 
                                                    CornerRadius="2" 
                                                    Margin="0,0,15,0" />

                                            <!-- En-tête de la preuve -->
                                            <StackPanel Grid.Column="1" Grid.Row="0" Orientation="Horizontal">
                                                <TextBlock Text="{Binding Name}" 
                                                           FontWeight="Bold" 
                                                           FontSize="16" />
                                                <Border Background="{Binding ThreatLevel, Converter={StaticResource ThreatToBrush}}" 
                                                        CornerRadius="4" 
                                                        Padding="5,2" 
                                                        Margin="10,0,0,0">
                                                    <TextBlock Text="{Binding ThreatLevel}" 
                                                               Foreground="White" 
                                                               FontSize="12" />
                                                </Border>
                                            </StackPanel>

                                            <!-- Chemin et type -->
                                            <StackPanel Grid.Column="1" Grid.Row="1" Orientation="Horizontal" Margin="0,5,0,0">
                                                <TextBlock Text="{Binding Path}" 
                                                           Foreground="{DynamicResource SecondaryTextBrush}" 
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock Text="|" 
                                                           Foreground="{DynamicResource SecondaryTextBrush}" 
                                                           Margin="10,0" />
                                                <TextBlock Text="{Binding Type}" 
                                                           Foreground="{DynamicResource AccentBrush}" />
                                            </StackPanel>

                                            <!-- Techniques MITRE -->
                                            <StackPanel Grid.Column="1" Grid.Row="2" Orientation="Horizontal" Margin="0,5,0,0">
                                                <TextBlock Text="Techniques MITRE: " 
                                                           Foreground="{DynamicResource SecondaryTextBrush}" />
                                                <ItemsControl ItemsSource="{Binding MITRETechniques}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <WrapPanel />
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border Background="{DynamicResource AccentLightBrush}" 
                                                                    CornerRadius="4" 
                                                                    Padding="5,2" 
                                                                    Margin="0,0,5,0">
                                                                <TextBlock Text="{Binding}" 
                                                                           Foreground="{DynamicResource AccentDarkBrush}" 
                                                                           FontSize="11" />
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </StackPanel>

                                            <!-- Contrôle de priorité -->
                                            <Grid Grid.Column="1" Grid.Row="3" Margin="0,10,0,0">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" 
                                                           Text="Priorité: " 
                                                           VerticalAlignment="Center" />
                                                <Slider Grid.Column="1" 
                                                        Minimum="1" 
                                                        Maximum="5" 
                                                        Value="{Binding Priority}" 
                                                        Tag="{Binding}"
                                                        ValueChanged="PrioritySlider_ValueChanged"
                                                        Margin="10,0" />
                                                <TextBlock Grid.Column="2" 
                                                           Text="{Binding Priority}" 
                                                           VerticalAlignment="Center" 
                                                           FontWeight="Bold" />
                                            </Grid>

                                            <!-- Actions -->
                                            <StackPanel Grid.Column="2" Grid.Row="0" Grid.RowSpan="4" 
                                                        Orientation="Vertical" 
                                                        VerticalAlignment="Center">
                                                <Button Style="{StaticResource IconButtonStyle}" 
                                                        ToolTip="Voir les détails"
                                                        Tag="{Binding}"
                                                        Click="ViewEvidenceButton_Click"
                                                        Margin="0,0,0,10">
                                                    <Image Source="/IRIS.Resources;component/Images/view.png" 
                                                           Width="20" 
                                                           Height="20" />
                                                </Button>
                                                <Button Style="{StaticResource IconButtonStyle}" 
                                                        ToolTip="Exclure"
                                                        Tag="{Binding}"
                                                        Click="ExcludeEvidenceButton_Click"
                                                        Visibility="{Binding IsExcluded, Converter={StaticResource BoolToVis}, ConverterParameter=invert}"
                                                        Margin="0,0,0,10">
                                                    <Image Source="/IRIS.Resources;component/Images/exclude.png" 
                                                           Width="20" 
                                                           Height="20" />
                                                </Button>
                                                <Button Style="{StaticResource IconButtonStyle}" 
                                                        ToolTip="Inclure"
                                                        Tag="{Binding}"
                                                        Click="IncludeEvidenceButton_Click"
                                                        Visibility="{Binding IsExcluded, Converter={StaticResource BoolToVis}}">
                                                    <Image Source="/IRIS.Resources;component/Images/include.png" 
                                                           Width="20" 
                                                           Height="20" />
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>
                </Border>

                <!-- Statistiques -->
                <Border Grid.Row="2" 
                        Background="{DynamicResource PanelBackgroundBrush}" 
                        CornerRadius="8" 
                        Padding="15" 
                        Margin="0,10,0,0"
                        Visibility="{Binding HasEvidence, Converter={StaticResource BoolToVis}}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Total" 
                                       FontWeight="SemiBold" />
                            <TextBlock Text="{Binding TotalItems}" 
                                       FontSize="20" 
                                       FontWeight="Bold" 
                                       Margin="0,5,0,0" />
                        </StackPanel>
                        <StackPanel Grid.Column="1">
                            <TextBlock Text="Priorité haute" 
                                       FontWeight="SemiBold" 
                                       Foreground="{DynamicResource HighPriorityBrush}" />
                            <TextBlock Text="{Binding HighPriorityItems}" 
                                       FontSize="20" 
                                       FontWeight="Bold" 
                                       Margin="0,5,0,0" />
                        </StackPanel>
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Menaces détectées" 
                                       FontWeight="SemiBold" 
                                       Foreground="{DynamicResource WarningBrush}" />
                            <TextBlock Text="{Binding ThreatsDetected}" 
                                       FontSize="20" 
                                       FontWeight="Bold" 
                                       Margin="0,5,0,0" />
                        </StackPanel>
                        <StackPanel Grid.Column="3">
                            <TextBlock Text="Exclus" 
                                       FontWeight="SemiBold" 
                                       Foreground="{DynamicResource SecondaryTextBrush}" />
                            <TextBlock Text="{Binding ExcludedItems}" 
                                       FontSize="20" 
                                       FontWeight="Bold" 
                                       Margin="0,5,0,0" />
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</Page>
